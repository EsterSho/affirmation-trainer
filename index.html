<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¢—Ä–µ–Ω–∞–∂—ë—Ä —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π</title>
<style>
  body { font-family: sans-serif; background: #1e293b; color: #f1f5f9; margin:0; padding:0; }
  .container { padding: 12px; max-width: 480px; margin: auto; }
  .affirmation { background: #334155; padding:10px 12px; border-radius:8px; margin-bottom:8px; display:flex; justify-content: space-between; align-items:center; }
  .affirm-text { flex:1; margin-right:8px; }
  .affirm-count { font-size:12px; color:#94a3b8; text-align:right; }
  button { cursor:pointer; border:none; border-radius:6px; padding:6px 10px; font-size:14px; }
  .btn-green { background:#16a34a; color:white; }
  .btn-green:hover { background:#15803d; }
  .btn-gray { background:#475569; color:white; }
  .stats { display:flex; justify-content:space-between; margin:12px 0; font-size:14px; }
  .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; }
  .modal-content { background:white; color:#1e293b; width:90%; max-width:400px; max-height:90%; overflow-y:auto; padding:12px; border-radius:10px; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .modal textarea { width:100%; margin-bottom:6px; border-radius:6px; padding:4px; font-size:14px; }
  .slide img { width:100%; border-radius:6px; margin-top:6px; }
  .ritual-line { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; background:#f1f5f9; padding:4px 6px; border-radius:4px; }
  .ritual-line button { background:#ef4444; color:white; padding:2px 6px; font-size:12px; }
  input[type="file"] { font-size:12px; }
  canvas { width:100% !important; height:200px !important; background:#334155; border-radius:8px; margin-top:16px; }
  .ritual-line { display:flex; gap:6px; align-items:flex-start; }
.ritual-line textarea{
  flex:1;
  border:none;
  background:transparent;
  resize:vertical;       /* –º–æ–∂–Ω–æ —Ç—è–Ω—É—Ç—å –≤–Ω–∏–∑ –ø–∞–ª—å—Ü–µ–º */
  overflow:hidden;       /* –∞–≤—Ç–æ–ø–æ–¥–≥–æ–Ω –≤—ã—Å–æ—Ç—ã –±–µ–∑ –ø–æ–ª–æ—Å—ã */
  padding:6px;
  font-size:14px;
  line-height:1.4;
  max-height:200px;      /* —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–ª–∞—Å—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ */
}
.ritual-line textarea:focus{ outline:none; }
  .modal-content{ -webkit-overflow-scrolling: touch; }
</style>
  <link rel="apple-touch-icon" href="icon.png">
</head>
<body>

<div class="container">
  <h1 style="text-align:center;margin-bottom:12px;">–¢—Ä–µ–Ω–∞–∂—ë—Ä —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π</h1>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats">
    <div>–°–µ–≥–æ–¥–Ω—è: <span id="today-count">0 –ø–æ–≤—Ç–æ—Ä–æ–≤</span></div>
    <div>–°—Ç—Ä–∏–∫: <span id="streak-count">0 –¥–Ω.</span></div>
  </div>

  <!-- 3 –≤–µ—á–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  <div id="permanent-affirmations"></div>

  <!-- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
  <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
  <div id="editable-affirmations"></div>
  <button id="add-affirm" class="btn-gray" style="width:100%;margin-bottom:12px;">–î–æ–±–∞–≤–∏—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</button>

  <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∏—Ç—É–∞–ª–∞ -->
  <button id="open-ritual" class="btn-green" style="width:100%;margin-bottom:12px;">–†–∏—Ç—É–∞–ª</button>

  <!-- –°–±—Ä–æ—Å –¥–Ω—è -->
  <button id="reset-day" class="btn-gray" style="width:100%;margin-bottom:12px;">–°–±—Ä–æ—Å –¥–Ω—è</button>

  <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
  <canvas id="progressChart"></canvas>
<div id="stats" style="margin-top:15px; font-size:14px; text-align:left; color:#333;"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∏—Ç—É–∞–ª–∞ -->
<div id="ritual-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–†–∏—Ç—É–∞–ª</h3>
      <button id="close-ritual">‚úñ</button>
    </div>

    <!-- –°–ª–∞–π–¥ -->
    <div class="slide" id="ritual-slide"></div>
    <input type="file" id="upload-slide">
    <button id="clear-slide" class="btn-gray" style="width:100%;margin:6px 0;">–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–∞–π–¥</button>

    <!-- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç —Ä–∏—Ç—É–∞–ª–∞ -->
    <div id="ritual-text"></div>
    <input type="text" id="new-ritual-line" placeholder="–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞">
    <button id="add-ritual-line" class="btn-green" style="width:100%;margin:6px 0;">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
    <button id="save-ritual" class="btn-green" style="width:100%;margin-bottom:6px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Ç—É–∞–ª</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
const STORAGE_KEYS = {
  AFF: 'affirm_trainer_affirmations_v1',
  HISTORY: 'affirm_trainer_history_v1',
  RITUAL: 'affirm_trainer_ritual_v1',
  SLIDE: 'affirm_trainer_slide_v1'
};

const todayKey = () => new Date().toISOString().slice(0,10);

// ====== –í–µ—á–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ======
const permanentAffirmations = [
  "–ú–æ—ë —Ç–µ–ª–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –∏—Å—Ü–µ–ª—è–µ—Ç—Å—è. –Ø –º–æ–ª–æ–¥, —Å–∏–ª—ë–Ω –∏ –ø–æ–ª–æ–Ω —ç–Ω–µ—Ä–≥–∏–∏.",
  "–Ø –∂–∏–≤—É –≤ –∏–∑–æ–±–∏–ª–∏–∏ –∏ –ª—é–±–≤–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π. –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã –º–Ω–µ.",
  "–Ø –ª—é–±–ª—é –∏ —Ü–µ–Ω—é —Å–µ–±—è. –Ø –≥–æ—Ç–æ–≤ –∫ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º –≤ –∏–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è."
];

// ====== –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ ======
let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)||'{}');
if(!history[todayKey()]) history[todayKey()] = Array(permanentAffirmations.length).fill(0);

function saveHistory(){ 
  localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history)); 
  updateStats(); 
  renderChart();
}

function updateStats(){
  const todaySum = history[todayKey()]?.reduce((a,b)=>a+b,0) || 0;
  document.getElementById('today-count').innerText = todaySum + ' –ø–æ–≤—Ç–æ—Ä–æ–≤';
  const streak = Object.keys(history).filter(k=>history[k].some(v=>v>0)).length;
  document.getElementById('streak-count').innerText = streak + ' –¥–Ω.';
}

// ====== –†–µ–Ω–¥–µ—Ä –≤–µ—á–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π ======
function renderPermanent(){
  const container = document.getElementById('permanent-affirmations');
  container.innerHTML='';
  permanentAffirmations.forEach((text,i)=>{
    const div = document.createElement('div');
    div.className='affirmation';
    div.innerHTML = `<div class="affirm-text">${text}<div class="affirm-count" id="count-perm-${i}">${history[todayKey()][i]}</div></div>
      <button class="btn-green" data-idx="${i}">‚úÖ</button>`;
    container.appendChild(div);
    div.querySelector('button').onclick = ()=>{
      history[todayKey()][i]++;
      saveHistory();
      document.getElementById(`count-perm-${i}`).innerText = history[todayKey()][i];
    };
  });
}

// ====== –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ======
let editableAffirmations = JSON.parse(localStorage.getItem(STORAGE_KEYS.AFF)||'[]');
function renderEditable(){
  const container = document.getElementById('editable-affirmations');
  container.innerHTML='';
  editableAffirmations.forEach((text,i)=>{
    const div = document.createElement('div');
    div.className='affirmation';
    div.innerHTML = `<input type="text" value="${text}" class="affirm-text">
      <div style="display:flex; flex-direction:column;align-items:flex-end;">
        <div class="affirm-count" id="count-edit-${i}">${history[todayKey()][i+3]||0}</div>
        <button class="btn-green" data-idx="${i}">‚úÖ</button>
        <button class="btn-gray remove-affirm" data-idx="${i}">‚úñ</button>
      </div>`;
    container.appendChild(div);

    div.querySelector('.affirm-text').onchange = (e)=>{
      editableAffirmations[i] = e.target.value;
      localStorage.setItem(STORAGE_KEYS.AFF, JSON.stringify(editableAffirmations));
    };
    div.querySelector('.btn-green').onclick = ()=>{
      history[todayKey()][i+3] = (history[todayKey()][i+3]||0)+1;
      saveHistory();
      document.getElementById(`count-edit-${i}`).innerText = history[todayKey()][i+3];
    };
    div.querySelector('.remove-affirm').onclick = ()=>{
      editableAffirmations.splice(i,1);
      localStorage.setItem(STORAGE_KEYS.AFF, JSON.stringify(editableAffirmations));
      renderEditable();
    };
  });
}

document.getElementById('add-affirm').onclick = ()=>{
  editableAffirmations.push('–ù–æ–≤–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ');
  localStorage.setItem(STORAGE_KEYS.AFF, JSON.stringify(editableAffirmations));
  if(!history[todayKey()]) history[todayKey()] = [];
  history[todayKey()].push(0);
  saveHistory();
  renderEditable();
};

// ====== –†–∏—Ç—É–∞–ª ======
let ritualText = JSON.parse(localStorage.getItem(STORAGE_KEYS.RITUAL)||'[]');
function renderRitual(){
  const container = document.getElementById('ritual-text');
  container.innerHTML = ritualText.map((line,idx)=>`
    <div class="ritual-line">
      <textarea rows="1" class="ritual-textarea" data-idx="${idx}">${line}</textarea>
      <button data-idx="${idx}">‚úñ</button>
    </div>
  `).join('');

  // –∞–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π textarea
  const autosize = (el)=>{
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 200) + 'px';
  };

  container.querySelectorAll('.ritual-textarea').forEach((ta)=>{
    autosize(ta); // –ø–æ–¥–≥–æ–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
    ta.addEventListener('input', (e)=>{
      const i = +e.target.dataset.idx;
      ritualText[i] = e.target.value; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –º–∞—Å—Å–∏–≤
      autosize(e.target);             // –ø–æ–¥–≥–æ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
    });
  });

  // —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
  container.querySelectorAll('button').forEach(btn=>{
    btn.onclick = (e)=>{
      const idx = +e.target.dataset.idx;
      ritualText.splice(idx,1);
      renderRitual();
    };
  });
}

document.getElementById('add-ritual-line').onclick = ()=>{
  const val = document.getElementById('new-ritual-line').value.trim();
  if(val){ ritualText.push(val); document.getElementById('new-ritual-line').value=''; renderRitual(); }
};

document.getElementById('save-ritual').onclick = ()=>{
  localStorage.setItem(STORAGE_KEYS.RITUAL, JSON.stringify(ritualText));
  alert('–†–∏—Ç—É–∞–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
};

document.getElementById('open-ritual').onclick = ()=>{
  document.getElementById('ritual-modal').style.display='flex';
  renderRitual();
  const slide = localStorage.getItem(STORAGE_KEYS.SLIDE);
  if(slide) document.getElementById('ritual-slide').innerHTML = `<img src="${slide}">`;
};

document.getElementById('close-ritual').onclick = ()=>{
  document.getElementById('ritual-modal').style.display='none';
};

// ====== –°–ª–∞–π–¥ ======
document.getElementById('upload-slide').onchange = (e)=>{
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(evt){
      localStorage.setItem(STORAGE_KEYS.SLIDE, evt.target.result);
      document.getElementById('ritual-slide').innerHTML = `<img src="${evt.target.result}">`;
    };
    reader.readAsDataURL(file);
  }
};
document.getElementById('clear-slide').onclick = ()=>{
  localStorage.removeItem(STORAGE_KEYS.SLIDE);
  document.getElementById('ritual-slide').innerHTML='';
};

// ====== –°–±—Ä–æ—Å ======
document.getElementById('reset-day').onclick = ()=>{
  history[todayKey()] = Array(permanentAffirmations.length+editableAffirmations.length).fill(0);
  saveHistory();
  renderPermanent();
  renderEditable();
};

// ====== –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ======
let chart;

function formatDate(date) {
  return date.toLocaleDateString("ru-RU", { day: "numeric", month: "short" });
}
function storageKey(date) {
  return date.toLocaleDateString("ru-RU");
}

// –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
function getLast7Days() {
  let days = [];
  for (let i = 6; i >= 0; i--) {
    let d = new Date();
    d.setDate(d.getDate() - i);
    days.push(d);
  }
  return days;
}

function renderChart() {
  const ctx = document.getElementById("progressChart").getContext("2d");
  const last7 = getLast7Days();

  // —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
  const labels = last7.map(d => formatDate(d));
  const data = last7.map(d => {
    let key = storageKey(d);
    return (history[key] || []).reduce((a, b) => a + b, 0);
  });

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "–ü–æ–≤—Ç–æ—Ä—ã –∑–∞ –¥–µ–Ω—å",
        data,
        borderColor: "#16a34a",
        backgroundColor: "#16a34a55",
        fill: false,                // ‚ùå —É–±–∏—Ä–∞–µ–º –∑–∞–ª–∏–≤–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–∏–Ω–∏—é
        tension: 0,                 // ‚ùå –¥–µ–ª–∞–µ–º –ø—Ä—è–º—ã–µ –ª–∏–Ω–∏–∏
        pointBackgroundColor: "#22c55e", // —Ç–æ—á–∫–∏ –∑–µ–ª—ë–Ω—ã–µ
        pointRadius: 6,             // —Ç–æ—á–∫–∏ –∫—Ä—É–ø–Ω–µ–µ
        pointHoverRadius: 8         // –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî –µ—â—ë –±–æ–ª—å—à–µ
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1            // üëâ —à–∞–≥ 1, –≤–∏–¥–Ω–æ –∫–∞–∂–¥—ã–π —Ä–æ—Å—Ç
          },
          title: { display: true, text: "–ü–æ–≤—Ç–æ—Ä—ã" }
        },
        x: {
          title: { display: true, text: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π" }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  updateStats();
}

// üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
function updateStats() {
  let allDays = Object.keys(history);
  let totals = allDays.map(k => (history[k] || []).reduce((a, b) => a + b, 0));
  let total = totals.reduce((a, b) => a + b, 0);

  let avg = (total / allDays.length) || 0;
  let maxDay = Math.max(0, ...totals);

  // streak (—Å–µ—Ä–∏—è)
  let streak = 0;
  let d = new Date();
  while (true) {
    let key = storageKey(d);
    if (history[key] && history[key].length > 0) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else break;
  }

  document.getElementById("stats").innerHTML = `
    üî¢ –í—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–æ–≤: <b>${total}</b><br>
    üìä –°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å: <b>${avg.toFixed(1)}</b><br>
    üèÜ –†–µ–∫–æ—Ä–¥–Ω—ã–π –¥–µ–Ω—å: <b>${maxDay}</b><br>
    üî• –°–µ—Ä–∏—è –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥: <b>${streak}</b>
  `;
}


// ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======
renderPermanent();
renderEditable();
updateStats();
renderChart();
</script>
</body>
</html>





